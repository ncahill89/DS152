<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Experimental Studies – Introduction to Data Science (2)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#establishing-causality" id="toc-establishing-causality" class="nav-link active" data-scroll-target="#establishing-causality">Establishing Causality</a></li>
  <li><a href="#controlled-experiments" id="toc-controlled-experiments" class="nav-link" data-scroll-target="#controlled-experiments">Controlled Experiments</a></li>
  <li><a href="#principles-of-experimental-design" id="toc-principles-of-experimental-design" class="nav-link" data-scroll-target="#principles-of-experimental-design">Principles of Experimental Design</a></li>
  <li><a href="#steps-of-experimentation" id="toc-steps-of-experimentation" class="nav-link" data-scroll-target="#steps-of-experimentation">Steps of Experimentation</a>
  <ul class="collapse">
  <li><a href="#define-the-problem-and-objectives" id="toc-define-the-problem-and-objectives" class="nav-link" data-scroll-target="#define-the-problem-and-objectives">1. Define the Problem and Objectives</a></li>
  <li><a href="#define-experimental-conditions" id="toc-define-experimental-conditions" class="nav-link" data-scroll-target="#define-experimental-conditions">2. Define Experimental Conditions</a></li>
  <li><a href="#identify-variables-of-interest" id="toc-identify-variables-of-interest" class="nav-link" data-scroll-target="#identify-variables-of-interest">3. Identify Variables of Interest</a></li>
  <li><a href="#identify-experimental-and-observational-units" id="toc-identify-experimental-and-observational-units" class="nav-link" data-scroll-target="#identify-experimental-and-observational-units">4. Identify Experimental and Observational Units</a></li>
  <li><a href="#define-observations-to-be-made" id="toc-define-observations-to-be-made" class="nav-link" data-scroll-target="#define-observations-to-be-made">5. Define Observations to be Made</a></li>
  <li><a href="#select-the-experimental-design" id="toc-select-the-experimental-design" class="nav-link" data-scroll-target="#select-the-experimental-design">6. Select the Experimental Design</a></li>
  <li><a href="#conduct-the-experiment" id="toc-conduct-the-experiment" class="nav-link" data-scroll-target="#conduct-the-experiment">7. Conduct the Experiment</a></li>
  <li><a href="#analyze-data-and-interpret-results" id="toc-analyze-data-and-interpret-results" class="nav-link" data-scroll-target="#analyze-data-and-interpret-results">8. Analyze Data and Interpret Results</a></li>
  </ul></li>
  <li><a href="#more-on-randomization" id="toc-more-on-randomization" class="nav-link" data-scroll-target="#more-on-randomization">More on Randomization</a>
  <ul class="collapse">
  <li><a href="#internal-validity" id="toc-internal-validity" class="nav-link" data-scroll-target="#internal-validity">Internal Validity</a></li>
  <li><a href="#external-validity" id="toc-external-validity" class="nav-link" data-scroll-target="#external-validity">External Validity</a></li>
  <li><a href="#example-tooth-growth" id="toc-example-tooth-growth" class="nav-link" data-scroll-target="#example-tooth-growth">Example: Tooth Growth</a></li>
  </ul></li>
  <li><a href="#more-on-blocking" id="toc-more-on-blocking" class="nav-link" data-scroll-target="#more-on-blocking">More on Blocking</a>
  <ul class="collapse">
  <li><a href="#randomized-complete-block-design-rcbd" id="toc-randomized-complete-block-design-rcbd" class="nav-link" data-scroll-target="#randomized-complete-block-design-rcbd">Randomized Complete Block Design (RCBD)</a></li>
  <li><a href="#example-oatvar" id="toc-example-oatvar" class="nav-link" data-scroll-target="#example-oatvar">Example: Oatvar</a></li>
  </ul></li>
  <li><a href="#factorial-experiments" id="toc-factorial-experiments" class="nav-link" data-scroll-target="#factorial-experiments">Factorial Experiments</a>
  <ul class="collapse">
  <li><a href="#designs" id="toc-designs" class="nav-link" data-scroll-target="#designs">Designs</a></li>
  <li><a href="#interactions" id="toc-interactions" class="nav-link" data-scroll-target="#interactions">Interactions</a></li>
  </ul></li>
  <li><a href="#factorial-experiments-tooth-growth" id="toc-factorial-experiments-tooth-growth" class="nav-link" data-scroll-target="#factorial-experiments-tooth-growth">Factorial Experiments: Tooth Growth</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Experimental Studies</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Studies where the researchers assign treatments to cases are called experiments. When this assignment includes randomization, e.g., using a coin flip to decide which treatment a patient receives, it is called a randomized experiment. Randomized experiments are fundamentally important when trying to show a causal connection between two variables.</p>
<section id="establishing-causality" class="level2">
<h2 class="anchored" data-anchor-id="establishing-causality">Establishing Causality</h2>
<ul>
<li><p>A treatment (exposure variable) will often be a binary variable that is either 0 or 1. It is 0 if the person is not treated, which is to say they are in the control group, and 1 if they are treated.</p></li>
<li><p>We will typically have some outcome of interest, Y, for each person or observational unit, and that could be categorical or continuous.</p></li>
<li><p>A treatment is causal if the outcome for a person, given they were not treated, is different to their outcome given they were treated.</p></li>
<li><p>If we could both treat and control the one individual at the one time, then we would know that it was only the treatment that had caused any change. However, the fundamental problem of causal inference is that we cannot both treat and control the same individual at the same time.</p>
<ul>
<li><p>we instead compare the average of two groups — all those treated and all those not.</p></li>
<li><p>we estimate the counterfactual at a group level because of the impossibility of doing it at an individual level.</p></li>
<li><p>this trade-off allows us to move forward but comes at the cost of certainty.</p></li>
<li><p>we must instead rely on randomization, probabilities, and expectations.</p></li>
</ul></li>
</ul>
</section>
<section id="controlled-experiments" class="level2">
<h2 class="anchored" data-anchor-id="controlled-experiments">Controlled Experiments</h2>
<p><strong>Controlled experiments</strong> are a scientific test (or a series of tests) to verify how one or more conditions (treatments - variables that are controlled by the scientist) effect one or more outcome (response) variables. We usually consider a default of there being no effect and we look for evidence that would cause us to change our mind.</p>
<p><strong>Design of experiments</strong> can produce an experiment that efficiently answers the questions of interest. The scientific method involves:</p>
<pre><code>(a) Stating a hypothesis
(b) Planning an experiment to objectively test the hypothesis
(c) Observing and carefully collecting data
(d) Interpreting experimental results </code></pre>
</section>
<section id="principles-of-experimental-design" class="level2">
<h2 class="anchored" data-anchor-id="principles-of-experimental-design">Principles of Experimental Design</h2>
<!-- **Control.** Need to control for effects due to factors other than the ones of primary interest. -->
<p><strong>Randomization.</strong> Subjects should be randomly selected from the population (where possible) and randomly divided into treatment groups to avoid unintentional selection bias in the groups and to account for variables that cannot be controlled. For example, some patients may be more susceptible to a disease than others due to their dietary habits. In this example dietary habit is a <em>confounding variable</em>, which is defined as a variable that is associated with both the exposure and outcome variables. Randomizing patients into the treatment or control group helps even out such differences.</p>
<!-- #### Confounding variables -->
<!-- **Confounding variables:** Extraneous variables that affect both the exposure and the outcome variables, and that make it seem like there is a relationship between them are called confounding variables. -->
<!-- ![](images/Confounding.jpg) -->
<p><strong>Replication.</strong> A sufficient number of subjects should be used to ensure that randomization creates groups that resemble each other closely and to increase the chances of detecting differences among the treatments when such differences actually exist. In a single study, we replicate by collecting a sufficiently large sample. What is considered sufficiently large varies from experiment to experiment, but at a minimum we want to have multiple subjects per treatment group.</p>
<p><strong>Local Control (Blocking).</strong> Researchers sometimes know or suspect that variables, other than the treatment, influence the response. Under these circumstances, they may first group individuals based on this variable into blocks and then randomize cases within each block to the treatment groups. This strategy is often referred to as blocking. For instance, if we are looking at the effect of a drug on heart attacks, we might first split patients in the study into low-risk and high-risk blocks, then randomly assign half the patients from each block to the control group and the other half to the treatment group. This strategy ensures that each treatment group has the same number of low-risk patients and the same number of high-risk patients.</p>
<hr>
</section>
<section id="steps-of-experimentation" class="level2">
<h2 class="anchored" data-anchor-id="steps-of-experimentation">Steps of Experimentation</h2>
<section id="define-the-problem-and-objectives" class="level3">
<h3 class="anchored" data-anchor-id="define-the-problem-and-objectives">1. Define the Problem and Objectives</h3>
<ul>
<li>Clearly state the research question and objectives.</li>
<li>Establish a logical progression: <em>Objectives → Scientific Hypotheses → Statistical Hypotheses</em>.</li>
<li>Examples:
<ul>
<li>Investigate the effect of Vitamin C on odontoblast length (cells responsible for tooth growth).</li>
<li>Determine the lethal dose of a pesticide for an agricultural pest.</li>
<li>Identify the optimal temperature settings for efficient machine operation.</li>
</ul></li>
</ul>
</section>
<section id="define-experimental-conditions" class="level3">
<h3 class="anchored" data-anchor-id="define-experimental-conditions">2. Define Experimental Conditions</h3>
<ul>
<li>Controlled conditions: Experiments conducted in controlled environments (e.g., greenhouses, laboratories, experimental stations).<br>
</li>
<li>Less controlled conditions: Field studies in natural settings (e.g., farms, forests).</li>
</ul>
</section>
<section id="identify-variables-of-interest" class="level3">
<h3 class="anchored" data-anchor-id="identify-variables-of-interest">3. Identify Variables of Interest</h3>
<ul>
<li>Outcome Variable (response variable): The outcome being measured.
<ul>
<li>Example: Odontoblast length in guinea pigs, blood pressure rates.</li>
</ul></li>
<li>Treatment Factors and Levels (exposure variables): Variables manipulated in the experiment.
<ul>
<li>Quantitative example: Vitamin C dose (0.5, 1, 2 mg/day).</li>
<li>Qualitative example: Diet type (natural vs.&nbsp;artificial).</li>
</ul></li>
<li>Local Control (Blocking) Factors: Variables controlled to reduce variability (e.g., environmental conditions, batch effects).</li>
</ul>
</section>
<section id="identify-experimental-and-observational-units" class="level3">
<h3 class="anchored" data-anchor-id="identify-experimental-and-observational-units">4. Identify Experimental and Observational Units</h3>
<ul>
<li>Experimental Unit: The smallest unit to which a treatment is randomly assigned.
<ul>
<li>Examples: 60 guinea pigs, a plot of land with 200 trees, a section of a laboratory bench with 20 Petri dishes.</li>
</ul></li>
<li>Observational Unit: The entity from which data is collected.
<ul>
<li>Examples: A single insect, tree, or Petri dish.</li>
</ul></li>
</ul>
</section>
<section id="define-observations-to-be-made" class="level3">
<h3 class="anchored" data-anchor-id="define-observations-to-be-made">5. Define Observations to be Made</h3>
<ul>
<li>Qualitative Observations: Presence or absence of a feature (e.g., morphological traits).<br>
</li>
<li>Quantitative Observations: Measurable data (e.g., weight, height, count, proportion).<br>
</li>
<li>Ordered Observations: Ranked data with an inherent order (e.g., disease severity, grading scales).</li>
</ul>
</section>
<section id="select-the-experimental-design" class="level3">
<h3 class="anchored" data-anchor-id="select-the-experimental-design">6. Select the Experimental Design</h3>
<ul>
<li>Choose the simplest design that meets the study’s needs without oversimplifying.</li>
</ul>
</section>
<section id="conduct-the-experiment" class="level3">
<h3 class="anchored" data-anchor-id="conduct-the-experiment">7. Conduct the Experiment</h3>
<ul>
<li>Ensure <strong>bias-free</strong> procedures by considering:
<ul>
<li>Who is conducting the experiment.</li>
<li>The location of the experiment.</li>
<li>Start and end dates.</li>
<li>The relevance and feasibility of the experiment.</li>
<li>Associated costs.</li>
</ul></li>
</ul>
</section>
<section id="analyze-data-and-interpret-results" class="level3">
<h3 class="anchored" data-anchor-id="analyze-data-and-interpret-results">8. Analyze Data and Interpret Results</h3>
<ul>
<li>Conduct analysis according to the experimental design.</li>
<li>Interpret results within the context of:
<ul>
<li>Experimental conditions.</li>
<li>Tested hypotheses.</li>
<li>Established scientific knowledge.</li>
</ul></li>
<li>Consider the potential consequences of incorrect conclusions.</li>
</ul>
<hr>
</section>
</section>
<section id="more-on-randomization" class="level2">
<h2 class="anchored" data-anchor-id="more-on-randomization">More on Randomization</h2>
<p>The key to telling a causal story is the counterfactual: what would have happened in the absence of the treatment. This means that establishing the control group is critical because when we do that, we establish the counterfactual. What we hope to be able to do is to find treatment and control groups that are the same, but for the treatment.</p>
<section id="the-benefits-to-randomization-are" class="level4">
<h4 class="anchored" data-anchor-id="the-benefits-to-randomization-are">The benefits to randomization are:</h4>
<ul>
<li><p>If a random assignment of treatment and controls groups is done then significant results can be concluded as causal or cause and effect conclusions. That is, that the treatment caused the result.</p></li>
<li><p>If random selection is done where the subjects are randomly selected from some population, then the results can be extended to that population. The random assignment is required for an experiment. When both random assignment and random selection are part of the study then we have a completely randomized experiment. Without random assignment (i.e., an observational study) then the treatment can only be referred to as being related to the outcome.</p></li>
</ul>
<p>To explore ideas of randomization, we simulate a population, and then randomly sample from it. We will set it up so that 20% of the population are smokers, and the rest are not.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">853</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>number_of_people <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">person =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>number_of_people),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">smoking_status =</span> <span class="fu">sample</span>(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">c</span>(<span class="st">"Smoker"</span>, <span class="st">"Non-Smoker"</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">size  =</span> number_of_people,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.2</span>,<span class="fl">0.8</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s look at population characteristics</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>population <span class="sc">%&gt;%</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(smoking_status)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  smoking_status     n
  &lt;chr&gt;          &lt;int&gt;
1 Non-Smoker      4003
2 Smoker           997</code></pre>
</div>
</div>
<p>Now let’s sample from the population and randomly assign a treatment and control group.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">853</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>sample_size <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">&lt;-</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">%&gt;%</span> </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_n</span>(sample_size) <span class="sc">%&gt;%</span> </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">sample</span>(</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">c</span>(<span class="st">"Treatment"</span>, <span class="st">"Control"</span>),</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">size  =</span> sample_size,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">replace =</span> <span class="cn">TRUE</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s look at sample characteristics within each group (treatment and control). Is the distribution of population characteristics reflected within each group?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>sample <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(group,  smoking_status) <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
# Groups:   group [2]
  group     smoking_status     n  prop
  &lt;chr&gt;     &lt;chr&gt;          &lt;int&gt; &lt;dbl&gt;
1 Control   Non-Smoker       364 0.747
2 Control   Smoker           123 0.253
3 Treatment Non-Smoker       415 0.809
4 Treatment Smoker            98 0.191</code></pre>
</div>
</div>
<hr>
</section>
<section id="internal-validity" class="level3">
<h3 class="anchored" data-anchor-id="internal-validity">Internal Validity</h3>
<ul>
<li>Internal validity is achieved when the <strong>only difference</strong> between the treatment and control groups is the treatment itself.<br>
</li>
<li>This ensures that the control group serves as a true <strong>counterfactual</strong>, allowing us to attribute differences in outcomes solely to the treatment.<br>
</li>
<li>In other words, our estimates reflect the <strong>true effect</strong> of the treatment rather than other confounding factors.<br>
</li>
<li>With strong internal validity, we can confidently make claims about <strong>causal relationships</strong> within the experiment.</li>
</ul>
</section>
<section id="external-validity" class="level3">
<h3 class="anchored" data-anchor-id="external-validity">External Validity</h3>
<ul>
<li>External validity refers to whether our experimental findings <strong>generalize</strong> beyond the study.<br>
</li>
<li>This requires:
<ol type="1">
<li>A sample that <strong>represents the broader population</strong>.<br>
</li>
<li>An experimental setup that <strong>mirrors real-world conditions</strong>.<br>
</li>
</ol></li>
<li>If these conditions hold, our results are applicable outside the experiment.<br>
</li>
<li><strong>Randomization is key</strong> to achieving external validity:
<ol type="1">
<li>First, random selection ensures that the study group is representative.<br>
</li>
<li>Second, random assignment to treatment and control ensures comparability within the experiment.</li>
</ol></li>
</ul>
<hr>
</section>
<section id="example-tooth-growth" class="level3">
<h3 class="anchored" data-anchor-id="example-tooth-growth">Example: Tooth Growth</h3>
<p>ToothGrowth is a built-in R dataset from a study that examined the effect of Vitamin C dose and delivery on the length of the odontoplasts, the cells responsible for teeth growth, in 60 guinea pigs, where tooth length was the measured outcome variable.</p>
<section id="randomization" class="level4">
<h4 class="anchored" data-anchor-id="randomization">Randomization</h4>
<p>Randomization of subjects in an experiment helps spread any variability that exists naturally between subjects evenly across groups.</p>
<p>In the experiment that yielded the ToothGrowth dataset, guinea pigs were randomized to receive Vitamin C either through orange juice or ascorbic acid, indicated in the dataset by the supp variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"ToothGrowth"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="replication" class="level4">
<h4 class="anchored" data-anchor-id="replication">Replication</h4>
<p>Replication means you need to conduct an experiment with an adequate number of subjects to achieve an acceptable statistical power.</p>
<p>Let’s examine the ToothGrowth dataset to make sure they followed the principle of replication. We’ll use a <code>dplyr</code> function called <code>count</code> to help us.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ToothGrowth <span class="sc">%&gt;%</span> <span class="fu">count</span>(supp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  supp  n
1   OJ 30
2   VC 30</code></pre>
</div>
</div>
</section>
<section id="analysis" class="level4">
<h4 class="anchored" data-anchor-id="analysis">Analysis</h4>
<p>Suppose you know from previous studies that the average length of a guinea pigs odontoplasts is 18 micrometers. Therefore, you hypothesize that odontoplast length is equal to 18. To “test” this hypothesis, let’s see how the value of 18 compares to our sample data by looking at the mean and standard deviation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ToothGrowth <span class="sc">%&gt;%</span> <span class="fu">pull</span>(len) <span class="sc">%&gt;%</span> mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 18.81333</code></pre>
</div>
</div>
<p>It’s natural to wonder if there is a difference in tooth length by supplement type. Use <code>group_by</code> and <code>summarise</code> to explore this and create an appropriate visualization using <code>ggplot</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ToothGrowth <span class="sc">%&gt;%</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="more-on-blocking" class="level2">
<h2 class="anchored" data-anchor-id="more-on-blocking">More on Blocking</h2>
<p>Often there are covariates in the experimental units that are known to affect the response variable and must be taken into account. Ideally an experimenter can group the experimental units into blocks where the within block variance is small, but the block to block variability is large.</p>
<ul>
<li>For example, in testing a drug to prevent heart disease, we know that gender and age also impact the outcome. We may want to partition our study participants into gender and age groups and then randomly assign the treatment (placebo vs drug) within the group.</li>
</ul>
<p>Often blocking variables are not the variables that we are primarily interested in, but must nevertheless be considered.</p>
<section id="randomized-complete-block-design-rcbd" class="level3">
<h3 class="anchored" data-anchor-id="randomized-complete-block-design-rcbd">Randomized Complete Block Design (RCBD)</h3>
<ul>
<li>The goal of RCBD is to <strong>maximize differences between blocks</strong> while ensuring <strong>similarity within each block</strong>.<br>
</li>
<li>This design helps control for known sources of variability, such as:
<ul>
<li>Temperature differences within a greenhouse.<br>
</li>
<li>Variation across different days.<br>
</li>
<li>Variation in fertility or drainage differences in a field<br>
</li>
</ul></li>
<li><strong>Key features:</strong>
<ul>
<li>Each <strong>block acts as a replicate</strong>.<br>
</li>
<li>The number of <strong>observational units per block</strong> equals the number of treatments.<br>
</li>
<li>Each treatment appears <strong>exactly once per block</strong>, with the <strong>order randomized</strong> within the block.</li>
</ul></li>
</ul>
<!-- ## Randomized Complete Block Design -->
<!-- Example with four treatments and three blocks -->
<!-- \begin{center} -->
<!-- \includegraphics[width = .9\textwidth]{figures/rcbd.png} -->
<!-- \end{center} -->
<section id="examples-of-blocks" class="level4">
<h4 class="anchored" data-anchor-id="examples-of-blocks">Examples of blocks</h4>
<ol type="1">
<li>Laboratory chamber with a humidity gradient inside</li>
</ol>
<p><img src="images/bod1.png" class="img-fluid" width="500"></p>
<ol start="2" type="1">
<li>Laboratory chambers with homogeneous temperature and humidity inside</li>
</ol>
<p><img src="images/bod2.png" class="img-fluid" width="500"></p>
<ol start="3" type="1">
<li>A field with a fertility gradient</li>
</ol>
<p><img src="images/field1.png" class="img-fluid" width="400"></p>
<ol start="4" type="1">
<li>A greenhouse with a temperature gradient during the day</li>
</ol>
<p><img src="images/greenhouse1.png" class="img-fluid" width="500"></p>
</section>
</section>
<section id="example-oatvar" class="level3">
<h3 class="anchored" data-anchor-id="example-oatvar">Example: Oatvar</h3>
<p>The dataset <code>oatvar</code> in the <code>faraway</code> library contains information about an experiment on eight different varieties of oats.</p>
<ul>
<li><p>The area in which the experiment was done had some systematic variability and the researchers divided the area up into five different blocks in which they felt the area inside a block was uniform while acknowledging that some blocks are likely superior to others for growing crops.</p></li>
<li><p>Within each block, the researchers created eight plots and randomly assigned a variety to a plot. This type of design is called a Randomized Complete Block Design (RCBD) because each block contains all possible levels of the factor of primary interest.</p></li>
</ul>
<p>Visualise the data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>oatvar <span class="ot">&lt;-</span> faraway<span class="sc">::</span>oatvar</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(oatvar, <span class="fu">aes</span>(<span class="at">y=</span>yield, <span class="at">x=</span>block, <span class="at">colour =</span> variety, <span class="at">group =</span> variety)) <span class="sc">+</span> </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="6-experiments_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Use <code>group_by</code> and <code>summarise</code> to look at the average yield within each variety.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>oatvar <span class="sc">%&gt;%</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Look at the results of using <code>lm</code> with variety and block as predictors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(....)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="factorial-experiments" class="level2">
<h2 class="anchored" data-anchor-id="factorial-experiments">Factorial Experiments</h2>
<p>Experiments that involve more than one treatment factor are called <em>factorial experiments</em>. In general, the number of treatments in a factorial experiment is the product of the numbers of levels of the treatment factors. The disadvantage of this is that the number of treatments increase very quickly.</p>
<p><strong>Example:</strong> Pest control</p>
<ul>
<li>Factor 1: two pesticides (A and B)</li>
<li>Factor 2: two doses</li>
<li>The experiment has a total of <span class="math inline">\(2\times 2 = 4\)</span> treatments</li>
</ul>
<p><strong>Example:</strong> The Tooth Growth data</p>
<ul>
<li>Factor 1: two deliveries of vitamin C (orange juice, ascorbic acid)</li>
<li>Factor 2: three doses (0.5, 1, and 2 mg/day)</li>
<li>The experiment has a total of <span class="math inline">\(2\times 3 = 6\)</span> treatments</li>
</ul>
<!-- \begin{center} -->
<!-- \includegraphics[width = .8\textwidth]{figures/fac1.png} -->
<!-- \end{center} -->
<section id="designs" class="level3">
<h3 class="anchored" data-anchor-id="designs">Designs</h3>
<p>For the Pesticide example, suppose 3 replicates and a completely randomized design</p>
<p><img src="images/fac2.png" class="img-fluid" width="500"></p>
<p>For the Pesticide example, suppose 3 replicates and a randomized complete block design</p>
<p><img src="images/fac3.png" class="img-fluid" width="500"></p>
</section>
<section id="interactions" class="level3">
<h3 class="anchored" data-anchor-id="interactions">Interactions</h3>
<p>The major advantage of factorial experiments is that they allow for the detection of interactions.</p>
<ul>
<li><p>Two factors are said to interact if the effect of one, on the response variable, depends upon the level of the other.</p></li>
<li><p>If they do not interact, they are said to be <strong>independent</strong>.</p></li>
</ul>
<section id="interaction-plots" class="level4">
<h4 class="anchored" data-anchor-id="interaction-plots">Interaction Plots</h4>
<p>A set of parallel lines indicates no interaction</p>
<p><img src="images/int1.png" class="img-fluid" width="400"></p>
<p>The crossing over of lines indicates an interaction</p>
<p><img src="images/int3.png" class="img-fluid" width="400"></p>
</section>
</section>
</section>
<section id="factorial-experiments-tooth-growth" class="level2">
<h2 class="anchored" data-anchor-id="factorial-experiments-tooth-growth">Factorial Experiments: Tooth Growth</h2>
<p>We’ve already seen to Tooth Growth data that examined the effect of Vitamin C delivery and dose on the length of the odontoplasts, the cells responsible for teeth growth, in 60 guinea pigs, where tooth length was the measured outcome variable.</p>
<p>We initially looked at how the Vitamin C delivery impacted tooth growth. Now lets consider what happens when we bring dose into the analysis. In this case we have two factors to consider instead of 1.</p>
<ul>
<li>Vitamin C delivery has 2 levels</li>
<li>dose has 3 levels (0.5, 1, and 2 mg/day)</li>
</ul>
<div class="cell" data-exercise="true">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"ToothGrowth"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ToothGrowth, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.factor</span>(dose), <span class="at">y =</span> len, <span class="at">colour =</span> supp)) <span class="sc">+</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="6-experiments_files/figure-html/tooth2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>